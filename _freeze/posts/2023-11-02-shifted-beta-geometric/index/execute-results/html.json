{
  "hash": "6aee764c87f77084082114a529915e09",
  "result": {
    "markdown": "---\ntitle: Estimating the Shifted Beta Geometric Model in Stan\ndate: \"2023-11-20\"\ncode-fold: true\necho: true\nfig-cap-location: top\ncategories: []\nnumber-sections: false\ndraft: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(cmdstanr)\n```\n:::\n\n\nThe shifted beta geometric model (sBG) is a model that is used to forecast retention/survival of users in contractual settings (think netflix, disney plus, tinder gold, etc). The model is quite simple and posits:\n\n* At the end of each period, a customer flips a coin: \"heads\" she cancels he contract, \"tails\" she renews it.\n* For each individual, the probability of a coin coming up \"heads\" does not change over time\n* The probabiliuty of heads varies across customers.  Fader and Hardie motivate the model in their paper *How to Project Customer Retention* and even provide a way to fit the model in excel. Neat!\n\nExcel isn't a great tool for fitting models, so Let's write this in Stan.\n\n## sBG in Stan\n\nThe two things we need are the probability density function and the survival function. Fader and Hardie provide these in their paper.  Mathematically, the probability density and survival function are\n\n$$ P(T=t \\mid \\alpha, \\beta) = \\dfrac{B(\\alpha+1, \\beta+t-1)}{B(\\alpha, \\beta)} \\>,$$\n\n$$ S(T=t \\mid \\alpha, \\beta) = \\dfrac{B(\\alpha, \\beta+t)}{B(\\alpha, \\beta)} \\>. $$\nHere, $B(\\alpha, \\beta)$ is the beta function *and not the beta distribution* (I made that mistake early).  Stan operates on the log scale, and so we'll have to take the log of these.  Stan has a log beta function called `lbeta` so we'll use that in our functions for the density and survival function.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```{.stan}\nfunctions{\n  real sbg_lpdf(real time, real alpha, real beta){\n    \n    return lbeta(alpha+1, beta+time-1) - lbeta(alpha, beta);\n  }\n  \n  real sbg_lccdf(real time, real alpha, real beta){\n    \n    return lbeta(alpha, beta + time) - lbeta(alpha, beta);\n  }\n  \n}\n```\n:::\n:::\n\n\nThe data we need to fit the model include:\n\n* How many customers were lost at each time period, \n* The times at which customers were lost, and\n* The total number of customers under observation\n\nWe'll also include an array of times at which to estimate the survival curve\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```{.stan}\ndata{\n  // Fitting the model\n  int N;\n  int n_total;\n  array[N] int lost;\n  array[N] real time;\n  \n  // Making Predictions\n  int N_pred;\n  array[N_pred] real pred_times;\n}\n```\n:::\n:::\n\n\n\nLater, we'll need the last time point we observed customers who haven't churned.  This is the truncation time\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```{.stan}\ntransformed data{\n  real truncation_time = max(time);\n}\n```\n:::\n:::\n\n\nAll that is left to do is specify parameters, write the model block, and generate predictions for our survival curve.  The likelihood computations are shown in the paper I referenced, so I'll let you read that if you're interested\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```{.stan}\nparameters{\n  real<lower=0> alpha;\n  real<lower=0> beta;\n}\nmodel{\n  alpha ~ cauchy(0, 1);\n  beta ~ cauchy(0, 1);\n  \n  for(i in 1:N){\n    target += lost[i] * sbg_lpdf(time[i]| alpha, beta);\n  }\n  target += (n_total - sum(lost)) * sbg_lccdf(truncation_time| alpha, beta);\n}\ngenerated quantities{\n  \n  array[N_pred] real expected_surviving;\n  \n  for(i in 1:N_pred){\n    expected_surviving[i] = exp(sbg_lccdf(pred_times[i]| alpha, beta));\n  }\n  \n}\n```\n:::\n:::\n\n# Fitting the Model\n\nFader and Hardie provide an example in their appendix for fitting the model.  We'll use that data to check our fit.  Let's take a look at that data now\n\n\n::: {.cell fig.asp='0.6'}\n\n```{.r .cell-code}\nlibrary(cmdstanr)\nlibrary(tidyverse)\nlibrary(tidybayes)\n\nstan_data <- list(\n  active = c(863 ,743 ,653 ,593 ,551 ,517 ,491),\n  lost = c(131, 126 ,90 ,60 ,42 ,34 ,26),\n  N = 7,\n  n_total = 1000,\n  time = 1:7,\n  N_pred = 25,\n  pred_times = seq(0, 12, length.out=25)\n)\n\n\nsurv_plot <- tibble(time = stan_data$time, active=stan_data$active) %>% \n              ggplot(aes(time, active)) + \n              geom_point() + \n              geom_line() + \n              ylim(c(0, 1000)) + \n              ylab('Customers Surviving') +\n              xlab('Time') + \n              see::theme_modern() + \n              theme(aspect.ratio = 1/1.61,\n                    panel.grid.major = element_line())\n\nsurv_plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=768}\n:::\n:::\n\n\nNow, let's compare with the fit\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- cmdstanr::cmdstan_model('sbg.stan')\n\nfit <- model$sample(stan_data, refresh = 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRunning MCMC with 4 sequential chains...\n\nChain 1 finished in 0.0 seconds.\nChain 2 finished in 0.0 seconds.\nChain 3 finished in 0.0 seconds.\nChain 4 finished in 0.0 seconds.\n\nAll 4 chains finished successfully.\nMean chain execution time: 0.0 seconds.\nTotal execution time: 0.5 seconds.\n```\n:::\n\n```{.r .cell-code}\npred_times <- tibble(pred_times=stan_data$pred_times, i = seq_along(pred_times))\nfit_predict <- fit %>% \n               spread_draws(expected_surviving[i]) %>% \n               mutate(expected_surviving = expected_surviving * 1000) %>% \n               mean_qi() %>% \n               left_join(pred_times)\n\n\n\nsurv_plot + \n  geom_line(data=fit_predict, aes(pred_times, expected_surviving), inherit.aes = F, color='red') + \n  geom_ribbon(data=fit_predict, aes(pred_times, ymin = .lower, ymax=.upper), inherit.aes = F, fill='red', alpha=0.5)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nNice, not a bad fit.\n\nModel extensions seem fairly straight forward.  You could maybe model alpha and beta much in the same way you do for a beta regression.\n\n\n# References\n\nFader, Peter S., and Bruce GS Hardie. \"How to project customer retention.\" Journal of Interactive Marketing 21.1 (2007): 76-90.",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}