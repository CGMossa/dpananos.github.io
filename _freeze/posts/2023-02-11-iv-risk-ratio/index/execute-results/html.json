{
  "hash": "c171382a2657b825db48544bb2bc6cbe",
  "result": {
    "markdown": "---\ntitle: \"Causal Risk Ratios in AB Tests with One Sided Non-Compliance\"\neditor: visual\ndate: \"2023-02-11\"\ncode-fold: false\necho: false\nfig-cap-location: top\n\ncategories: [AB Tests, Statistics, Causal Inference]\nnumber-sections: false\n---\n\n\nSometimes we run AB tests where engaging with the treatment (and hence being treated) is optional. Since assignment to treatment is random, we can use the randomization as an instrumental variable (assuming there is a strong correlation between the instrument and the treatment, and that there are no backdoor paths between randomization and the final outcome).\n\nThere are a few libraries to do estimate the LATE from an instrumental variable.  However, none of them report a causal risk ratio, which is usually our choice of causal contrast for better or worse. \n\nIn this post, I'm putting together some much appreciated advice from [@guilhermejd1](https://twitter.com/guilhermejd1/status/1624196853947416576) and [dimitry on cross validated](https://stats.stackexchange.com/a/605042/111259) on how to estimate a causal risk ratio in a randomized experiment with one sided non-compliance.  I'll first demonstrate how to do this with a simulation where we will actually have potential outcomes with which to compare.  Then, I'll apply this approach to a real experiment I helped run at Zapier.\n\n## Simulation\n\nLet $A$ be a binary indicator for assignment to treatment (1) or control. Let $d_j^a$ be the potential outcome for engaging with the treatment under treatment $A=a$ for user $j$.  Due to construction of the experiment, $d_j^0 = 0  \\forall j$ because users in control can not engage in the treatment by design (\"[t]his is different than the typical experiment in labor economics, where people can take up job training somewhere else even if they are in the control group\", writes dimitry).  This means that we have two types of users in treatment group: $d_j^1 = 1$ is a \"complier\" and $d_j^0 = 0$ is a \"never taker\". If our outcome is $y$, then LATE is the ATE for compliers and is also the ATT. \n\n\nLet's set up a simulation.  Here are some details:\n\n* $A$ is decided by a coinflip (i.e. bernoulli with probability of success 0.5)\n* There is an unmeasured confounder $w$, which is also distributed in the population via a coinflip.\n* The confounder and the treatment effect the probability of engaging with the treatment (being a complier).  $P\\left(d_j^1 = 1 \\mid A=1, w\\right) = 0.4 - 0.2w$.  Because of the one sided compliance $P(d_j^0=1) = 0$.\n* Probability of the outcome is $P\\left( y^a_j=1 \\mid d^{a}_j, w \\right) = 0.1 + 0.5w + 0.1d_j^{a}$.  So the instrument only effects the outcome through compliance.\n\nLet's simuilate this in R\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(kableExtra)\n\nset.seed(0)\nN<- as.integer(1e6) # Lots of precision\nA <- rbinom(N, 1, 0.5)\nw <- rbinom(N, 1, 0.5)\n\n# Potential outcomes\nd_0 <- 0\nd_1 <- rbinom(N, 1, 0.3 - 0.2*w + 0.1*A)\ny_0 <- rbinom(N, 1, 0.1 + 0.5*w)\ny_1 <- rbinom(N, 1, 0.1 + 0.5*w + 0.1*d_1)\n\n# and now the observed data via switching equation\ny <- A*y_1 + (1-A)*y_0\nd <- A*d_1 + (1-A)*d_0\ncomplier <- d==1\n```\n:::\n\n\n\nFrom our setup, $LATE = 0.1$.  Let's compute that from our potential outcomes and estimate it using $A$ as an instrument. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_late <- mean(y_1[d_1==1]) - mean(y_0[d_1==1])\nest_late <- cov(y, A)/cov(d, A)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>True LATE, sample LATE, and estimated LATE.  All 3 agree to within 3 decimal places and any differences are just sampling variability.</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> True LATE </th>\n   <th style=\"text-align:right;\"> Sample LATE </th>\n   <th style=\"text-align:right;\"> IV Estimate of LATE </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 0.1 </td>\n   <td style=\"text-align:right;\"> 0.101 </td>\n   <td style=\"text-align:right;\"> 0.103 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Estimating The Causal Risk Ratio\n\nIn order to compute the causal risk ratio we need two quantities:\n\n* An estimate of $E[y^1_j \\mid d^1]$, and\n* An estimate of $E[y^0_j \\mid d^1]$.\n\n$E[y^1_j \\mid d^1]$ is easy to estimate; just compute the average outcome of those users in treatment who engaged with the treatment. Now because $LATE = E[y^1_j \\mid d^1] - E[y^0_j \\mid d^1]$, the second estimate we need is obtained from some algebra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Estimate from the data\nE_y1 <- mean(y[d==1])\nE_y0 <- E_y1 - est_late # use the estimate, not the truth\n\nE_y1/E_y0\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.389267\n```\n:::\n:::\n\n\n\nLet's compare this to the true estimate of the causal risk ratio using potential outcomes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(y_1[complier])/mean(y_0[complier])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.381259\n```\n:::\n:::\n\n\nWhich is pretty damn close.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}